# OWASP Top Ten Risks -2021 十大漏洞 
```
OWASP是一個幫助開發者了解WEB的開發漏洞的非營利性開放社群組織。
```

  | 弱點(vulnerability) |描述|
  |----------|----|
  |權限控制失效 (Broken Access Control)|沒有確切驗證使用者身分。|
  |加密機制失效 (Cryptographic Failures)|沒有使用高安全性之加密技術所以http連線易被駭客劫持。|
  |注入式攻擊 (Injection)|沒有嚴格驗證前端的輸入資訊造成伺服器資訊被洩漏。|
  |不安全設計 (Insecure Design)|沒有考量網站安全性的設計,易造成網站很多層面的漏洞。|
  |安全設定缺陷 (Security Misconfiguration)|沒有確認系統或系統套件或資料庫有配置上的是否正確配置。|
  |危險或過時的元件 (Vulnerable and Outdated Components)|沒有定期更先系統套件版本以修補漏洞。|
  |認證及驗證機制失效 (Identification and Authentication Failures)|沒有嚴格確認使用者的存取身分造成資料完整性破壞。|
  |軟體及資料完整性失效 (Software and Data Integrity Failures)|沒有定期更先系統配件與資料庫版本進行漏洞修補。|
  |資安記錄及監控失效 (Security Logging and Monitoring Failures)|沒有確認日誌與監控是否完整配置。|
  |伺服端請求偽造 (Server-Side Request Forgery)|沒有嚴格確認造訪者請求的存取身分。|

## 網站攻擊手法介紹
### 權限控制失效 (Broken Access Control)
- **水平權限提升 (Horizontal Privilege Escalation)**
  - 場景： 用戶A和用戶B各有自己的帳號，但用戶A能夠訪問用戶B的資源。
  - 實例：
  - URL為/user/profile?id=2，未檢查用戶是否有權限訪問ID為2的資料。
  - 用戶A直接將URL中的id=2改成id=3，成功獲取用戶B的資料。
  - 改進建議：
  - 在每個請求中驗證用戶的身份和所請求資源的所有權。
- **垂直權限提升 (Vertical Privilege Escalation)**
  - 場景： 低權限用戶能夠執行只有高權限用戶（如管理員）才能執行的操作。
  - 實例：
  - 普通用戶在瀏覽器的開發者工具中將角色從user修改為admin，即可執行管理員操作。
  - 改進建議：
  - 在伺服器端強制檢查用戶的角色權限，而非依賴客戶端數據。
- **未授權的直接對象參考 (Insecure Direct Object References, IDOR)**
  - 場景： 用戶能直接通過參數（如文件名、ID）訪問後端的敏感資源，且未檢查權限。
  - 實例：
  - URL為/files/download?file=report.pdf，用戶可以改為file=admin_report.pdf來下載未授權的文件。
  - 改進建議：
  - 使用不可猜測的參數（如UUID）。
  - 在後端檢查用戶是否有權限訪問該資源。
- **功能級別的未授權訪問**
  - 場景： 應用未正確限制用戶訪問某些功能的權限。
  - 實例：
  - 普通用戶通過訪問URL如/admin/deleteUser直接執行管理員操作。
  - 改進建議：
  - 在後端檢查每個功能的權限，確保只有授權用戶可以執行。
- **敏感數據暴露**
  - 場景： 用戶能訪問不應該暴露的敏感數據。
  - 實例：
  - API返回的JSON包含用戶的角色和權限，攻擊者修改這些數據來提升自身權限。
  - 改進建議：
  - 僅返回用戶需要的數據。
  - 在伺服器端驗證用戶的每個操作權限。
- **未實施基於會話的權限檢查**
  - 場景： 用戶登錄後的會話不受限於特定的角色或範圍。
  - 實例：
  - 用戶在會話中直接修改請求的參數，模擬其他用戶執行操作。
  - 改進建議：
  - 每次操作都應檢查用戶的會話範圍和權限。
### 加密機制失效 (Cryptographic Failures)
- **未加密敏感數據傳輸**
  - 場景： 某網站的登入表單未使用HTTPS傳輸，導致用戶密碼以明文形式傳輸。
  - 後果： 攻擊者可以使用工具（如Wireshark）攔截密碼。
  - 改進建議：
  - 強制使用HTTPS（啟用TLS 1.2或更高版本）。
  - 配置HSTS（HTTP Strict Transport Security）以防止降級攻擊。
- **使用弱加密算法**
  - 場景： 應用程序使用MD5或SHA-1來存儲用戶密碼。
  - 後果： 攻擊者可使用彩虹表快速破解這些密碼。
  - 改進建議：
  - 使用強哈希算法（如bcrypt、scrypt或Argon2）並加鹽處理。
- **密鑰硬編碼**
  - 場景： 加密密鑰直接寫入應用程式代碼中，如：
   ```
  key = "my_secret_key_123"
  ```
  - 後果： 若攻擊者取得代碼，密鑰將被暴露，威脅數據安全。
  - 改進建議：
  - 使用安全的密鑰管理服務（如AWS KMS、Azure Key Vault）。
  - 在環境變數中存儲密鑰，而非代碼中。
- **不安全的TLS配置**
  - 場景： 伺服器允許使用TLS 1.0或1.1，並啟用不安全的加密套件（如RC4）。
  - 後果： 攻擊者可利用已知漏洞進行中間人攻擊。
  - 改進建議：
  - 禁用TLS 1.0/1.1，僅啟用TLS 1.2或更高版本。
  - 使用強加密套件（如AES-GCM）。
- **未加密數據存儲**
  - 場景： 敏感數據（如支付卡信息）以明文存儲於資料庫中。
  - 後果： 若資料庫被洩露，所有數據將直接暴露。
  - 改進建議：
  - 使用AES-256等強加密算法加密存儲敏感數據。
  - 確保加密密鑰的安全存儲和輪換。
- **加密過程中忽視數據完整性**
  - 場景： 使用AES-CBC模式進行加密，但未實施訊息驗證碼（MAC）。
  - 後果： 攻擊者可進行位元翻轉攻擊（Bit-Flipping Attack），篡改數據而不被發現。
  - 改進建議：
  - 使用帶有驗證的加密模式（如AES-GCM、ChaCha20-Poly1305）。
- **重複使用加密密鑰或IV**
  - 場景： AES-CBC模式下重複使用相同的IV進行多次加密。
  - 後果： 攻擊者可通過模式分析數據洩露部分信息。
  - 改進建議：
  - 為每次加密生成唯一的IV。
  - 使用帶有內建IV生成的模式（如AES-GCM）。
### 注入式攻擊 (Injection)
- **SQL Injection (SQL注入)**
  - 實例： 場景：網站登入功能。 輸入框的SQL查詢如下：

  ```
  SELECT * FROM users WHERE username = '$username' AND password = '$password';
  ```
  - 攻擊者輸入：
  ```
  Username: ' OR '1'='1
  Password: ' OR '1'='1
  ```
  - 結果生成的SQL查詢：
  ```
  SELECT * FROM users WHERE username = '' OR '1'='1' AND password = '' OR '1'='1';
  ```
- 這會使查詢永遠為真，攻擊者成功繞過身份驗證，進入系統。
- **Command Injection (命令注入)**
  - 實例： 場景：Web應用允許用戶透過輸入IP地址來Ping伺服器。 後端代碼：
  ```
  ping -c 4 $user_input
  ```
  - 攻擊者輸入：

  ```
  127.0.0.1; rm -rf /
  ```
  - 結果生成的命令：

  ```
  ping -c 4 127.0.0.1; rm -rf /
  ```
  - 這會導致系統執行rm -rf /，刪除伺服器的所有檔案。
- **Cross-Site Scripting (XSS)**
- 實例： 場景：留言板系統未對用戶輸入進行驗證或轉義。 攻擊者留言：
  ```
  <script>alert('XSS Attack!')</script>
  ```
  - 當其他用戶訪問這個頁面時，惡意腳本會在他們的瀏覽器中執行，可能竊取Cookie或其他敏感數據。
- **NoSQL Injection**
- 實例： 場景：基於MongoDB的應用。 查詢：

  ```
  db.users.find({ username: userInput.username, password: userInput.password });
  ```
  - 攻擊者輸入：

  ```
  Username: {"$ne": null}
  Password: {"$ne": null}
  ```
  - 結果生成的查詢：

  ```
  db.users.find({ username: {"$ne": null}, password: {"$ne": null} });
  ```
  - 這將返回所有用戶，繞過身份驗證。
- **Path Traversal (路徑穿越)**
- 實例： 場景：Web應用允許用戶指定文件名來讀取文件內容。 代碼：

  ```
  file_path = "/var/www/html/files/" + user_input
  with open(file_path, "r") as file:
  data = file.read()
  ```
  - 攻擊者輸入：

  ```
  ../../etc/passwd
  ```
  - 結果生成的路徑：

  ```
  /var/www/html/files/../../etc/passwd
  ```
  - 這導致應用讀取並暴露敏感文件。


### 不安全設計 (Insecure Design)
- **缺乏多因素身份驗證**
  - 場景：一個高風險應用僅依賴簡單的用戶名和密碼進行登錄。
  - 後果：若用戶密碼被竊取（如透過釣魚攻擊或憑證洩漏），攻擊者可輕易取得系統訪問權限。
  - 改進建議：引入多因素身份驗證（MFA），如OTP、硬體令牌。
- **未設計登錄嘗試次數限制**
  - 場景：用戶登錄系統時，可以無限制地嘗試不同的密碼。
  - 後果：攻擊者可利用暴力破解工具反覆嘗試密碼，最終可能成功登錄。
  - 改進建議：
  - 增加登錄嘗試次數限制。
  - 實施延遲機制，增加每次錯誤嘗試的時間間隔。
- **敏感數據明文存儲**
  - 場景：用戶密碼、支付卡信息等敏感數據未加密存儲在資料庫中。
  - 後果：若資料庫被洩漏，攻擊者可直接獲取用戶的敏感信息。
  - 改進建議：
  - 使用強哈希算法（如bcrypt）存儲密碼。
  - 對其他敏感數據使用AES等加密算法。
- **功能設計忽視權限檢查**
  - 場景：某應用的管理功能透過URL直接訪問，如 /admin/deleteUser。
  - 後果：未經身份驗證的用戶能直接訪問這些功能，進行敏感操作。
  - 改進建議：在所有敏感操作中強制進行權限檢查。
- **未考慮API安全性**
  - 場景：後端API接口未設計驗證機制，允許任何人發送請求。
  - 後果：攻擊者可透過攔截工具（如Burp Suite）模擬合法請求，操作後端數據。
  - 改進建議：
  - 引入API身份驗證機制（如JWT）。
  - 實施速率限制以防止濫用。
### 安全設定缺陷 (Security Misconfiguration)
- **使用不安全的預設配置**
  - 場景： 某個管理介面（如Web應用或路由器）仍然使用預設的帳號和密碼，例如：
  ```
  Username: admin
  Password: admin
  ```
  - 後果： 攻擊者可輕易利用這些預設帳戶進行未授權訪問。
  - 改進建議：
  - 部署後立即更改所有預設帳號和密碼。
  - 強制使用強密碼策略。
- **未禁用不必要的功能**
  - 場景： Web伺服器啟用了不必要的功能或模組，例如：
  - Apache或Nginx中的目錄瀏覽（Directory Listing）。
  - 過時的API或未使用的開發工具。
  - 後果： 攻擊者可透過目錄瀏覽功能查看應用程式檔案結構，找到敏感資訊或利用漏洞。
  - 改進建議：
  - 禁用不必要的模組和功能。
  - 定期審查伺服器配置，確保最小化攻擊面。
- **未更新系統或軟體**
  - 場景： 使用過時的伺服器軟體或應用程式框架（如PHP、Apache、Tomcat）。
  - 後果： 攻擊者可利用已知漏洞（如Log4j漏洞）攻擊系統。
  - 改進建議：
  - 定期檢查並安裝安全補丁。
  - 使用自動化工具（如Ansible、Chef）進行更新管理。
- **未正確設置錯誤處理**
  - 場景： Web應用在出錯時顯示詳細的錯誤信息，例如：
  - mathematica
  ```
  java.lang.NullPointerException
  at ...
  ```
  - 後果： 攻擊者可透過錯誤信息了解系統架構、文件路徑、數據庫結構等敏感信息。
  - 改進建議：
  - 在生產環境中禁用詳細錯誤訊息。
  - 使用通用的錯誤頁面替代（如 "500 - Internal Server Error"）。
- **不安全的雲端存儲配置**
  - 場景： 雲端服務（如Amazon S3 Bucket、Google Cloud Storage）設置為公開訪問。
  - 後果： 敏感數據（如使用者資料或API金鑰）可能被公開。
  - 改進建議：
  - 設置存儲資源為私有。
  - 僅允許必要的帳號或IP地址存取。
  - 啟用雲服務的安全掃描工具（如AWS Config）。
- **未正確設置安全標頭**
  - 場景： Web應用未設置安全標頭，例如：
  - Content-Security-Policy（防止XSS攻擊）。
  - Strict-Transport-Security（強制使用HTTPS）。
  - 後果： 攻擊者可利用這些缺陷進行跨站腳本攻擊（XSS）或中間人攻擊。
  - 改進建議：
  - 實施適當的HTTP安全標頭。
  - 使用工具（如SecurityHeaders.com）檢測配置狀態。
- **缺乏訪問控制**
  - 場景： 管理界面未限制IP地址或未啟用身份驗證。
  - 後果： 攻擊者可直接訪問管理界面並嘗試暴力破解。
  - 改進建議：
  - 限制管理界面的訪問來源（如僅允許內部網路）。
  - 啟用多因素身份驗證（MFA）。
- **開發或測試環境暴露**
  - 場景： 部署的伺服器同時啟用了測試環境或開發工具，例如：
  - /debug或/test路徑暴露。
  - 後果： 攻擊者可利用測試功能執行未授權的操作。
  - 改進建議：
  - 移除所有開發或測試功能。
  - 在生產環境中僅部署必要的組件。
### 危險或過時的元件 (Vulnerable and Outdated Components)

### 認證及驗證機制失效 (Identification and Authentication Failures)
- **弱密碼政策**
  - 問題： 系統允許用戶使用過於簡單或常見的密碼。
  - 後果： 攻擊者可利用暴力破解或憑證填充攻擊（Credential Stuffing）輕易獲得未授權訪問。
  - 實例： 用戶設置的密碼為「123456」或「password」。
  - 改進建議：
    - 強制使用強密碼（至少8-12個字符，包含大小寫字母、數字和特殊字符）。
    - 實施密碼黑名單，禁止使用常見弱密碼。
- **暴力破解防護缺失**
  - 問題： 登錄系統未限制嘗試次數，允許攻擊者反覆嘗試密碼。
  - 後果： 攻擊者可進行暴力破解或字典攻擊。
  - 實例： 一個API接口無限制地接受密碼嘗試，未設置速率限制。
  - 改進建議：
    - 實施登錄次數限制（如3-5次失敗後鎖定帳戶）。
    - 增加漸進式延遲機制，每次失敗嘗試增加等待時間。
- **多因素認證（MFA）缺失**
  - 問題： 高風險操作未使用多因素認證。
  - 後果： 攻擊者即使獲得用戶憑證，也可直接執行操作。
  - 實例： 金融應用允許用戶僅透過密碼進行轉帳操作。
  - 改進建議：
    - 為高風險功能（如交易、密碼重置）實施MFA。
    - 使用TOTP（Time-Based One-Time Password）、硬體令牌或生物辨識作為額外因素。
- **Session 管理不當**
  - 問題： 使用不安全的會話機制，如不正確地管理會話ID或未實施過期策略。
  - 後果： 攻擊者可能通過會話劫持取得未授權訪問。
  - 實例：
    - 不將會話ID標記為 HttpOnly 或 Secure。
    - 會話ID不隨登出而失效。
  - 改進建議：
    - 確保會話ID在HTTPS傳輸中標記為 Secure。
    - 用戶登出或會話過期時，立即使會話ID失效。
    - 定期輪換長期有效的會話ID。
- **未正確保護密碼**
  - 問題： 密碼存儲時未加密或使用弱哈希算法（如MD5、SHA-1）。
  - 後果： 攻擊者若獲取資料庫，可輕易破解密碼。
  - 實例： 資料庫中存儲的密碼以明文形式存儲。
  - 改進建議：
    - 使用強哈希算法（如bcrypt、scrypt、Argon2）並加鹽存儲密碼。
    - 定期審計存儲密碼的安全性。
- **密碼重置機制薄弱**
  - 問題： 密碼重置流程未經適當驗證，如直接允許用戶更改密碼。
  - 後果： 攻擊者可利用該機制重置其他用戶的密碼。
  - 實例： 密碼重置鏈接未設置過期時間，或鏈接易於猜測。
  - 改進建議：
    - 發送密碼重置鏈接到用戶註冊的電子郵件。
    - 重置鏈接應該唯一且設置過期時間（如15分鐘）。
- **未驗證的API請求**
  - 問題： 後端API缺少身份驗證機制，或接受來自未授權用戶的請求。
  - 後果： 攻擊者可利用該漏洞執行未授權操作。
  - 實例： API端點 /deleteUser 無需身份驗證即可執行刪除操作。
  - 改進建議：
    - 為所有API端點實施身份驗證（如JWT）。
    - 確保API的身份驗證與用戶角色一致。
- **登錄回應過於詳細**
  - 問題： 登錄失敗回應顯示過多信息（如「密碼錯誤」或「帳號不存在」）。
  - 後果： 攻擊者可利用此信息確定有效用戶名。
  - 實例： 登錄頁面提示：「用戶名不存在」。
  - 改進建議：
    - 使用通用錯誤信息（如「登錄失敗，請檢查用戶名和密碼」）。

### 軟體及資料完整性失效 (Software and Data Integrity Failures)

### 資安記錄及監控失效 (Security Logging and Monitoring Failures)
- **缺乏關鍵事件記錄**
  - 問題：系統未記錄關鍵活動（如登入嘗試、敏感操作、權限更改等）。
  - 後果：攻擊者的行為無法被追蹤或調查。
  - 實例：未記錄管理員帳號的登入失敗次數，無法發現暴力破解嘗試。
- **記錄內容不完整**
  - 問題：記錄中缺少重要資訊，如IP地址、用戶身份、操作時間等。
  - 後果：無法準確定位事件來源或分析攻擊行為。
  - 實例：日誌只記錄「用戶登入失敗」，但未記錄失敗原因或IP來源。
- **日誌存儲不足或過期**
  - 問題：日誌被覆蓋或未長期保存，導致過去事件無法調查。
  - 後果：延遲發現的攻擊行為可能無法被分析。
  - 實例：系統僅保留最近7天的日誌，而未保存數月的記錄供審計使用。
- **缺乏監控和告警機制**
  - 問題：未針對關鍵事件設置監控和告警。
  - 後果：無法即時響應安全事件。
  - 實例：多次失敗登入未觸發告警，攻擊者最終成功暴力破解密碼。
- **日誌未受保護**
  - 問題：日誌可以被未授權的用戶修改或刪除。
  - 後果：攻擊者可隱藏其行為，避免被偵測。
  - 實例：攻擊者入侵伺服器後，清除所有操作記錄。
- **未集中管理日誌**
  - 問題：多系統的日誌未統一收集和分析。
  - 後果：難以從多個來源關聯分析事件。
  - 實例：應用伺服器和資料庫伺服器的日誌分散，無法確認一次SQL注入攻擊的完整路徑。

### 伺服端請求偽造 (Server-Side Request Forgery)
- **訪問內部資源**
  - 問題： 應用允許用戶提供的URL作為目標，伺服器未檢查請求的合法性。
  - 實例： API允許通過URL獲取資料，如：
  ```
  GET /fetch?url=http://example.com/data
  ```
  - 攻擊者修改為：
  ```
  /fetch?url=http://127.0.0.1/admin
  ```
  - 伺服器向內部資源發送請求，導致內部敏感數據洩露。
  - 後果： 攻擊者可能訪問內部API、管理介面或私有服務。
- **端口掃描**
  - 問題： 攻擊者利用伺服器掃描內部網路中的開放端口。
  - 實例： 發送多個請求：
  ```
  /fetch?url=http://127.0.0.1:22
  /fetch?url=http://127.0.0.1:80
  ```
  - 根據伺服器的回應，確定哪些端口是開放的。
  - 後果： 攻擊者能繼續針對特定服務進行攻擊。
- **攻擊內部服務**
  - 問題： 攻擊者利用SSRF發送惡意請求到內部的敏感服務（如Metadata服務）。
  - 實例： 在雲環境中，攻擊者請求：
  ```
  /fetch?url=http://169.254.169.254/latest/meta-data/
  ```
  - 伺服器返回AWS EC2 Metadata（如訪問密鑰）。
  - 後果： 攻擊者可能竊取雲服務憑證，進一步控制資源。
- **文件伺服器利用**
  - 問題： SSRF請求用於訪問文件系統服務（如file://協議）。
  - 實例：
  ```
  /fetch?url=file:///etc/passwd
  ```
  - 伺服器返回敏感的系統文件內容。
  - 後果： 攻擊者可能獲取系統用戶信息，嘗試暴力破解或進一步入侵。
- **跨站請求**
  - 問題： SSRF可用於攻擊第三方服務。
  - 實例： 攻擊者請求：
  ```
  /fetch?url=http://victim.com/malicious
  ```
  - 伺服器以自己的身份發出請求，可能繞過IP封鎖或驗證限制。
  - 後果： 攻擊者利用伺服器對第三方目標進行攻擊，隱藏來源IP。

